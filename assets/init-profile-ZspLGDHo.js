import{i as C,H as U,b as A,u as F,s as b,j as k}from"./app-YCXN7p87.js";import{a as T,d as y,b as O,e as B,r as I,S as z,g as H,s as M,f as j,h as R}from"./state-DSxtQ4Ks.js";async function V(){const e=document.querySelector(".profile-billing__form");if(!e)return;const t=e.querySelector(".profile-billing__submit"),{data:{user:s}}=await C();if(!s)return;const r=await T();if(r){if(e.cardNumber.value=r.card_number||"",r.expiry_month&&r.expiry_year){const o=String(r.expiry_month).padStart(2,"0"),c=String(r.expiry_year).slice(-2);e.expiry.value=`${o}/${c}`}e.cvc.value=r.cvc||""}const n={cardNumber:/^\d{12,16}$/,expiry:/^(0[1-9]|1[0-2])\/\d{2}$/,cvc:/^\d{3,4}$/};function a(o,c){const f=o.closest(".profile-billing__field"),g=f?.querySelector(".profile-billing__error--required"),w=f?.querySelector(".profile-billing__error--pattern");g?.classList.remove("visible"),w?.classList.remove("visible"),c==="required"&&g?.classList.add("visible"),c==="pattern"&&w?.classList.add("visible"),o.classList.add("invalid")}function d(o){o.closest(".profile-billing__field")?.querySelectorAll(".visible").forEach(f=>f.classList.remove("visible")),o.classList.remove("invalid")}function i(o){const c=o.value.trim();let f=o.id;f==="billing-cardNumber"&&(f="cardNumber"),f==="billing-expiry"&&(f="expiry"),f==="billing-cvc"&&(f="cvc");const g=n[f];return c?g&&!g.test(c)?(a(o,"pattern"),!1):(d(o),!0):(a(o,"required"),!1)}e.querySelector("#billing-cardNumber")?.addEventListener("input",o=>{i(o.target)}),e.querySelector("#billing-cvc")?.addEventListener("input",o=>{i(o.target)}),e.querySelector("#billing-expiry")?.addEventListener("input",o=>{let c=o.target.value.replace(/\D/g,"");c.length>4&&(c=c.slice(0,4)),c.length>=2&&(c=c.slice(0,2)+"/"+c.slice(2)),o.target.value=c,c?n.expiry.test(c)?d(o.target):a(o.target,"pattern"):a(o.target,"required")});function p(){return Object.fromEntries(new FormData(e).entries())}let u=p();t&&(t.disabled=!0),e.addEventListener("input",()=>{const o=JSON.stringify(p())!==JSON.stringify(u);t&&(t.disabled=!o,t.classList.toggle("disabled",!o))}),e.addEventListener("submit",async o=>{o.preventDefault();let c=!0;if(["billing-cardNumber","billing-expiry","billing-cvc"].forEach(g=>{const w=e.querySelector(`#${g}`);w&&!i(w)&&(c=!1)}),!c){y("Please fix the errors in the form","error");return}const f=p();try{const g=await O({cardNumber:f.cardNumber,expiry:f.expiry,cvc:f.cvc});if(g?.error)throw new Error(g.error.message);y("Payment method saved successfully","success"),u=p(),t&&(t.disabled=!0,t.classList.add("disabled"))}catch(g){console.error("Save error:",g),y("Failed to save payment method","error")}})}const W=`<div class="profile-order-item" data-order-id="{{orderId}}">\r
    <div class="profile-order-item__header">\r
        <div class="profile-order-item__header-content">\r
            <p class="profile-order-item__date">{{orderDate}}</p>\r
            <a class="profile-order-item__number" href="/checkout?order={{orderId}}">No {{orderNumber}}</a>\r
        </div>\r
        <p class="profile-order-item__status">{{status}}</p>\r
    </div>\r
\r
    <div class="profile-order-item__table">\r
        {{#each items}}\r
        <div class="profile-order-item__row">\r
            <a href="/product?id={{id}}" class="profile-order-item__link" style="color: black;">\r
                <div class="profile-order-item__image-wrapper {{categoryClass}}">\r
                    <img\r
                    class="profile-order-item__image"\r
                    src="./img/components/products/{{image}}.png"\r
                    alt="{{title}}"\r
                    loading="lazy"\r
                    />\r
                </div>\r
            </a>\r
            <div class="profile-order-item__content">\r
                <div class="profile-order-item__content-inner">\r
                    <p class="profile-order-item__category {{categoryClass}}">{{category}}</p>\r
                    <p class="profile-order-item__description">\r
                        {{quantity}} x {{title}}\r
                    </p>\r
                </div>\r
\r
            <p class="profile-order-item__price">\${{price}}</p>\r
            </div>\r
        </div>\r
        {{/each}}\r
    </div>\r
\r
    <div class="profile-order-item__footer">\r
        <div class="profile-order-item__amount">\r
            <span>Order Amount:</span>\r
            <strong>\${{totalAmount}}</strong>\r
        </div>\r
        <button class="profile-order-item__btn-reorder" data-order-id="{{orderId}}">\r
            Add to Cart\r
        </button>\r
    </div>\r
</div>`,J=U.compile(W),Y={"Vitamins & Dietary Supplements":"category--vitamins",Minerals:"category--minerals","Pain Relief":"category--pain",Probiotics:"category--probiotics",Antioxidants:"category--antioxidants","Weight Loss":"category--weight-loss","Prenatal Vitamins":"category--prenatal-vitamins"};function G(e){return new Date(e).toLocaleDateString("en-US",{day:"numeric",month:"long",year:"numeric"})}function Z(e){return e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():""}function Q(e,t){if(!e||e.length===0)return t.innerHTML='<p class="profile-orders__empty">You have no orders yet</p>',[];const s=e.map(r=>{console.log(r);const n=r.order_items.map(a=>({category:a?.category||"Unknown",categoryClass:Y[a?.category]||"category--default",title:a?.title||"Product",quantity:a.quantity,price:(parseFloat(a.price)*a.quantity).toFixed(2),image:a.image}));return{orderId:r.id,orderDate:G(r.created_at),orderNumber:r.id,items:n,totalAmount:parseFloat(r.total_price).toFixed(2),status:Z(r.status)}});return console.log(s),t.innerHTML=s.map(r=>J(r)).join(""),s}function K(e){e.querySelectorAll(".profile-order-item__btn-reorder").forEach(s=>{const r=async n=>{n.preventDefault();const a=s.dataset.orderId;s.disabled=!0;const d=s.textContent;s.textContent="Adding...";try{const i=await I(a);if(console.log(i),i.error)throw new Error(i.error.message);y("Items added to cart successfully!","success");const p=await A();F(p),s.disabled=!1,s.textContent=d}catch(i){console.error("Error reordering:",i),y("Failed to add items to cart","error"),s.disabled=!1,s.textContent=d}};s.addEventListener("click",r)})}async function X(e){const t=document.querySelector(".profile-order__list");if(t)try{const s=await B(e);console.log(s),Q(s,t),K(t)}catch(s){console.error("Error loading orders:",s),t.innerHTML='<p class="profile-orders__error">Failed to load orders</p>'}}async function ee(e){const{data:{user:t}}=await b.auth.getUser();if(!t)throw new Error("Not authorized");const s=Date.now(),r=Math.random().toString(36).substring(2,8),n=e.name.replace(/[^a-zA-Z0-9.-]/g,"_"),d=`temp/${`${s}-${r}-${n}`}`;console.log("Uploading to temp path:",d);const{error:i}=await b.storage.from("documents").upload(d,e);if(i)throw console.error("Upload error:",i),i;const{error:p}=await b.auth.updateUser({data:{temp_document_path:d}});if(p)throw console.error("Error updating user metadata:",p),p;return{success:!0}}async function x(e){try{const{data:t,error:s}=await b.storage.from("documents").list(`wholesale/${e}`,{sortBy:{column:"created_at",order:"desc"}});if(s)return console.error("Error listing files:",s),{fileUrl:null,fileName:null};if(!t||t.length===0)return{fileUrl:null,fileName:null};const r=t[0],n=r.name.split("-").slice(2).join("-")||r.name,a=`wholesale/${e}/${r.name}`,{data:d}=b.storage.from("documents").getPublicUrl(a);return{fileUrl:d.publicUrl,fileName:n,fullFileName:r.name,uploadedAt:r.created_at}}catch(t){return console.error("Error getting wholesale document:",t),{fileUrl:null,fileName:null}}}async function re(){const e=document.querySelector(".checkout-form");if(!e)return;const t=e.querySelector(".profile-overview__submit-btn"),s=e.querySelector("#state"),r=e.querySelector(".profile-overview__document-input"),n=e.querySelector(".profile-overview__document-btn"),a=e.querySelector(".profile-overview__document-document-filename"),d=r?.closest(".checkout-form__field");let i=document.querySelector(".profile-overview__document-link");!i&&d&&(i=document.createElement("a"),i.className="profile-overview__document-link",i.target="_blank",i.rel="noopener noreferrer",i.style.display="none",d.appendChild(i)),s&&z.getStatesOfCountry("US").forEach(l=>{const m=document.createElement("option");m.value=l.isoCode,m.textContent=l.isoCode,s.appendChild(m)});const p=await H();p&&(e.firstName.value=p.first_name||"",e.lastName.value=p.last_name||"",e.address1.value=p.address1||"",e.address2.value=p.address2||"",e.city.value=p.city||"",e.state.value=p.state||"",e.zip.value=p.zip||"",e.email.value=p.email||"",e.phone.value=p.phone||"");const{data:{user:u}}=await C(),o=u?.user_metadata?.role,c=document.querySelector(".profile__section-customer");if(o==="wholesale"){c.textContent="Wholesale Customer",d&&(d.style.display="block");const{fileUrl:l,fileName:m}=await x(u.id);console.log(l,m),l&&m&&(a.textContent=m,a.classList.add("show"),d.classList.add("has-file"),i&&(i.href=l,i.style.display="inline",i.textContent="View Document"))}else c.textContent="Regular Customer",d&&(d.style.display="none");o==="wholesale"&&n&&r&&(n.addEventListener("click",l=>{l.preventDefault(),r.click()}),r.addEventListener("change",async()=>{const l=r.files[0];if(!l)return;if(!["image/jpeg","image/png","application/pdf"].includes(l.type)){y("Only PDF, JPG or PNG allowed","error"),r.value="";return}a.textContent=l.name,a.classList.add("show"),d.classList.add("has-file"),i&&(i.style.display="none"),n.disabled=!0;const v=n.textContent;n.textContent="Uploading...";try{await ee(l);const{data:{session:_}}=await b.auth.getSession();if(!_)throw new Error("No active session");const h=await fetch("https://qdqbtiofhnjnfvortswl.supabase.co/functions/v1/init-wholesale-user",{method:"POST",headers:{Authorization:`Bearer ${_.access_token}`,"Content-Type":"application/json"}});if(!h.ok){const $=await h.text();throw console.error("Edge function error:",$),new Error("Failed to process document")}await h.json();const{fileUrl:S,fileName:D}=await x(u.id);S&&D&&(a.textContent=D,i&&(i.href=S,i.style.display="inline",i.textContent="View Document")),y("Document uploaded successfully","success")}catch(_){console.error("Upload failed:",_),y("Upload failed: "+_.message,"error");const{fileUrl:h,fileName:S}=await x(u.id);h&&S?(a.textContent=S,i&&(i.href=h,i.style.display="inline")):(a.classList.remove("show"),d.classList.remove("has-file"),i&&(i.style.display="none")),r.value=""}finally{n.disabled=!1,n.textContent=v}}));const f={firstName:/^[A-Za-zА-Яа-яЁёЇїІіЄєҐґ\s'-]{2,}$/,lastName:/^[A-Za-zА-Яа-яЁёЇїІіЄєҐґ\s'-]{2,}$/,address1:/^.{5,}$/,city:/^[A-Za-zА-Яа-яЁёЇїІіЄєҐґ\s'-]{2,}$/,zip:/^\d{1,10}$/,email:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,phone:/^\+?\d{10,15}$/};function g(l,m){const v=l.closest(".checkout-form__field"),_=v?.querySelector(".form__error_required"),h=v?.querySelector(".form__error_pattern");_?.classList.remove("visible"),h?.classList.remove("visible"),m==="required"&&_?.classList.add("visible"),m==="pattern"&&h?.classList.add("visible"),l.classList.add("invalid")}function w(l){l.closest(".checkout-form__field")?.querySelectorAll(".visible").forEach(v=>v.classList.remove("visible")),l.classList.remove("invalid")}function N(l){const m=l.value.trim(),v=f[l.id];return m?v&&!v.test(m)?(g(l,"pattern"),!1):(w(l),!0):(g(l,"required"),!1)}e.querySelectorAll("input").forEach(l=>{f[l.id]&&l.addEventListener("input",()=>N(l))}),s?.addEventListener("change",l=>{l.target.value?w(l.target):g(l.target,"required")});function L(){return Object.fromEntries(new FormData(e).entries())}let P=L();t&&(t.disabled=!0),e.addEventListener("input",()=>{const l=JSON.stringify(L())!==JSON.stringify(P);t&&(t.disabled=!l,l?t.classList.remove("disabled"):t.classList.add("disabled"))}),e.addEventListener("submit",async l=>{l.preventDefault();let m=!0;if(Object.keys(f).forEach(_=>{const h=e.querySelector(`#${_}`);h&&!N(h)&&(m=!1)}),s&&!s.value&&(g(s,"required"),m=!1),!m)return;const v=L();try{await M({firstName:v.firstName,lastName:v.lastName,address1:v.address1,address2:v.address2||"",city:v.city,state:v.state,zip:v.zip,email:v.email,phone:v.phone}),y("Changes successfully saved","success"),P=L(),t&&(t.disabled=!0)}catch(_){console.error("Save error:",_),y("Failed to update profile","error")}})}function E(e,t){const s=e.closest(".profile-password__field");s?.querySelectorAll(".visible").forEach(a=>a.classList.remove("visible"));let r=t;t==="invalid-current"&&(r="pattern"),s?.querySelector(`.profile-password__error--${r}`)?.classList.add("visible"),e.classList.add("invalid")}function q(e){e.closest(".profile-password__field")?.querySelectorAll(".visible").forEach(s=>s.classList.remove("visible")),e.classList.remove("invalid")}async function te(){const e=document.querySelector("#password-form");if(!e)return;const t=e.querySelector(".profile-password__submit"),s=e.querySelector("#current-password"),r=e.querySelector("#new-password"),n=e.querySelector("#confirm-password");function a(){let d=!0;return s.value.trim()?q(s):(E(s,"required"),d=!1),r.value.trim()?q(r):(E(r,"required"),d=!1),n.value.trim()?r.value!==n.value?(E(n,"match"),d=!1):q(n):(E(n,"required"),d=!1),t.disabled=!d,d}[s,r,n].forEach(d=>{d.addEventListener("input",a)}),a(),e.addEventListener("submit",async d=>{if(d.preventDefault(),!!a()){t.disabled=!0,t.textContent="Checking...";try{const{data:{user:i}}=await b.auth.getUser();if(!i||!i.email)throw new Error("User not found");const{error:p}=await b.auth.signInWithPassword({email:i.email,password:s.value});if(p){E(s,"invalid-current"),t.disabled=!1,t.textContent="Update Password",y("Current password is incorrect","error");return}const{error:u}=await b.auth.updateUser({password:r.value});if(u)throw u;y("Password updated successfully","success"),e.reset(),a()}catch(i){console.error("Error:",i),y(`Failed to update password ${i}`,"error")}finally{t.disabled=!1,t.textContent="Save"}}})}function se(){const e=document.querySelectorAll(".profile-sidebar__btn:not(.signout)"),t=document.querySelectorAll(".profile__section");function s(u){return new URLSearchParams(window.location.search).get(u)}function r(u,o){const c=new URL(window.location);c.searchParams.set(u,o),window.history.pushState({},"",c)}function n(u){t.forEach(c=>{c.classList.remove("active")});const o=document.getElementById(`section-${u}`);o&&o.classList.add("active"),e.forEach(c=>{c.classList.remove("active"),c.dataset.section===u&&c.classList.add("active")}),r("tab",u)}e.forEach(u=>{u.addEventListener("click",o=>{o.preventDefault();const c=u.dataset.section;n(c)})});const a=s("tab"),i=a&&["overview","orders","subscriptions","billing","password"].includes(a)?a:"subscriptions";n(i);const p=document.querySelector(".profile-sidebar__btn.signout");p&&p.addEventListener("click",async u=>{u.preventDefault(),await k(),window.location.href="/"}),window.addEventListener("popstate",()=>{const u=s("tab")||"subscriptions";n(u)})}const ie=`<div class="profile-subs-items">\r
    <div class="profile-subs-items__wrapper">\r
        <a href="/product?id={{id}}" class="profile-subs-items__link" style="color: black;">\r
            <div class="profile-subs-items__image-wrapper {{categoryClass}}">\r
                <img\r
                class="profile-subs-items__image"\r
                src="./img/components/products/{{image}}.png"\r
                alt="{{title}}"\r
                loading="lazy"\r
                />\r
            </div>\r
        </a>\r
        <div class="profile-subs-items__content-outer">\r
            <div class="profile-subs-items__content">\r
                <p class="profile-subs-items__category {{categoryClass}}">{{category}}</p>\r
                <div class="profile-subs-items__content-inner">\r
                    <p class="profile-subs-items__title">{{quantity}} x {{title}}</p>\r
                    <span class="profile-subs-items__price">\${{price}}</span>\r
                </div>\r
            </div>\r
\r
            <div class="profile-subs-items__shipment-wrapper">\r
                <div class="profile-subs-items__shipment">\r
                    <p class="profile-subs-items__shipment-interval">Shipment every {{autoship_interval}} days</p>\r
                    <p class="profile-subs-items__shipment-next">Next delivery: {{autoship_next}}</p>\r
                </div>\r
                <button class="profile-subs-items__btn" data-subscription-id="{{subscriptionId}}">Unsubscribe</button>\r
            </div>\r
        </div>\r
\r
\r
    </div>\r
</div>`,oe=U.compile(ie),ae={"Vitamins & Dietary Supplements":"category--vitamins",Minerals:"category--minerals","Pain Relief":"category--pain",Probiotics:"category--probiotics",Antioxidants:"category--antioxidants","Weight Loss":"category--weight-loss","Prenatal Vitamins":"category--prenatal-vitamins"};function ne(e){const t=new Date(e),s=t.getDate(),r=le(s),n=t.toLocaleDateString("en-US",{month:"short"}),a=t.getFullYear();return`${s}${r} ${n} ${a}`}function le(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}function ce(e,t){if(!e||e.length===0)return t.innerHTML='<p class="profile-subs__empty">You have no active subscriptions</p>',[];const s=e.map(r=>{const n={id:r.product_id,subscriptionId:r.id,title:r.title,image:r.image,price:(parseFloat(r.price_at_purchase)*r.quantity).toFixed(2),quantity:r.quantity,autoship_interval:`Shipment every ${r.autoship_interval} days`,autoship_next:ne(r.next_payment_date),category:r.category};return n.categoryClass=ae[r.category]||"category--default",n});return t.innerHTML=s.map(r=>oe(r)).join(""),s}async function de(e,t){try{const s=await j(e);return ce(s,t),s}catch(s){return console.error("Error refreshing subscriptions:",s),t.innerHTML='<p class="profile-subs__error">Failed to load subscriptions</p>',[]}}function ue(e,t){e.querySelectorAll(".profile-subs-items__btn").forEach(r=>{const n=r.clickHandler;n&&r.removeEventListener("click",n);const a=async d=>{d.preventDefault();const i=r.dataset.subscriptionId,p=r.closest(".profile-subs-items");if(confirm("Are you sure you want to unsubscribe?"))try{r.disabled=!0;const u=r.textContent;r.textContent="Processing...";const o=await R(i);if(o.error)throw new Error(o.error.message);r.disabled=!1,r.textContent=u,await pe(p)}catch(u){console.error("Error unsubscribing:",u),r.disabled=!1,r.textContent="Unsubscribe"}};r.clickHandler=a,r.addEventListener("click",a)})}function pe(e){return new Promise(t=>{e.style.transition="all 0.3s ease",e.style.opacity="0",e.style.transform="translateX(-20px)",setTimeout(()=>{e.remove(),t()},300)})}async function fe(e){const t=document.querySelector(".profile-subs__list");if(t)try{await de(e,t),ue(t,e)}catch(s){console.error("Error loading subscriptions:",s),t.innerHTML='<p class="profile-subs__error">Failed to load subscriptions</p>'}}async function ge(){const{data:{user:e}}=await C();e&&(se(),console.log("user",e.id),fe(e.id),X(e.id),re(),V(),te())}export{ge as initProfile};
