import{H as x,f as b,s as E,h as L}from"./app-YCXN7p87.js";import{g as C,a as F,s as D,b as A,c as N,d as $,S as O}from"./state-DSxtQ4Ks.js";const P=`<article class="checkout-item" data-productId="{{id}}">\r
    <div class="checkout-item__wrapper">\r
        <a href="/product?id={{id}}" class="checkout-item__link" style="color: black;">\r
            <div class="checkout-item__image-wrapper {{categoryClass}}">\r
                <img\r
                    class="checkout-item__image"\r
                    src="./img/components/products/{{image}}.png"\r
                    alt="{{title}}"\r
                    loading="lazy"\r
                />\r
            </div>\r
        </a>\r
        \r
        <div class="checkout-item__content">\r
            <p class="checkout-item__title">{{quantity}} <span>x</span>{{title}}</p>\r
            <div class="checkout-item__price">\r
            {{#if discount}}\r
                <span class="checkout-item__price--old">\${{oldPrice}}</span>\r
                <span class="checkout-item__price--new">\${{price}}</span>\r
            {{else}}\r
                <span class="checkout-item__price--regular">\${{price}}</span>\r
            {{/if}}\r
            </div>\r
        </div>\r
\r
\r
\r
    </div>\r
</article>`,R=x.compile(P),z={"Vitamins & Dietary Supplements":"category--vitamins",Minerals:"category--minerals","Pain Relief":"category--pain",Probiotics:"category--probiotics",Antioxidants:"category--antioxidants","Weight Loss":"category--weight-loss","Prenatal Vitamins":"category--prenatal-vitamins"};function I(l,s){if(console.log(l),!l||!Array.isArray(l))return;const t=l.map(o=>{const c={id:o.product_id,title:o.title,image:o.image,price:parseFloat(o.price),discount:parseFloat(o.discount),quantity:o.quantity};return c.discount>0&&(c.oldPrice=c.price,c.price=(c.price*(1-c.discount/100)).toFixed(2)),c.categoryClass=z[o.category]||"category--default",c});if(t.length===0){s.innerHTML="<p>Your order is empty</p>";return}return s.innerHTML=t.map(o=>R(o)).join(""),t}function T(l){const s=document.querySelector(".checkout__order-price"),t=document.querySelector(".checkout__order-discount"),o=document.querySelector(".checkout__order-shipping"),c=document.querySelector(".checkout__order-total"),_=document.querySelector(".checkout__order-opener-total"),S=document.querySelector(".checkout__order-pricing.discount");let n=0,u=0;l.forEach(d=>{const v=d.oldPrice||d.price,e=parseFloat(d.price);n+=v*d.quantity,d.oldPrice&&(u+=(v-e)*d.quantity)});const g=n*.05,m=n-u+g;u||(S.style="display:none"),s.textContent=`$${n.toFixed(2)}`,t.textContent=`-$${u.toFixed(2)}`,o.textContent=`$${g.toFixed(2)}`,c.textContent=`$${m.toFixed(2)}`,_.textContent=`$${m.toFixed(2)}`}function B(){const l=O.getStatesOfCountry("US"),s=document.getElementById("state");s&&(l.forEach(t=>{const o=document.createElement("option");o.value=t.isoCode,o.textContent=t.isoCode,s.appendChild(o)}),s.value||(s.selectedIndex=0))}function M(){const l=document.querySelector(".checkout__order-opener"),s=document.querySelector(".checkout__order-opener-arrow"),t=document.querySelector(".checkout__order");l.addEventListener("click",o=>{o.preventDefault(),s.classList.toggle("active"),t.classList.toggle("active"),l.classList.toggle("active")})}async function U(){M();const s=new URLSearchParams(window.location.search).get("order");if(!s)return;const t=document.getElementById("checkout-form");t.querySelector(".checkout__submit");const o=document.querySelector(".checkout__order-list");B();const c=await b(s);if(!c)return;c.status==="success"&&(window.location.href=`/checkout-success?order=${s}`);const _=I(c.order_items,o);T(_);const{data:{user:S}}=await E.auth.getUser();if(!S){window.location.href="/login";return}const n=await C();n&&(t.firstName.value=n.first_name||"",t.lastName.value=n.last_name||"",t.address1.value=n.address1||"",t.address2.value=n.address2||"",t.city.value=n.city||"",t.state.value=n.state||"",t.zip.value=n.zip||"",t.phone.value=n.phone||"",t.email.value=n.email||"");const u=await F();if(u){if(t.cardNumber.value=u.card_number||"",u.expiry_month&&u.expiry_year){const e=String(u.expiry_month).padStart(2,"0"),r=String(u.expiry_year).slice(-2);t.expiry.value=`${e}/${r}`}t.cvc.value=u.cvc||""}const g={firstName:/^[A-Za-zА-Яа-яЁёЇїІіЄєҐґ\s'-]{2,}$/,lastName:/^[A-Za-zА-Яа-яЁёЇїІіЄєҐґ\s'-]{2,}$/,address1:/^.{5,}$/,city:/^[A-Za-zА-Яа-яЁёЇїІіЄєҐґ\s'-]{2,}$/,zip:/^\d{0,10}$/,email:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,phone:/^\+?\d{10,15}$/,cardNumber:/^\d{12,20}$/,expiry:/^(0[1-9]|1[0-2])\/\d{2}$/,cvc:/^\d{3,4}$/};function m(e,r){const a=e.closest('[class*="checkout-form__field"]'),f=a.querySelector(".form__error_required"),i=a.querySelector(".form__error_pattern");if(e.id==="state"){const y=document.querySelector(".checkout-form__field.state .form__error_required");y&&(y.classList.add("visible"),e.classList.add("invalid"));return}f?.classList.remove("visible"),i?.classList.remove("visible"),r==="required"&&f?.classList.add("visible"),r==="pattern"&&i?.classList.add("visible"),e.classList.add("invalid")}function d(e){const r=e.closest('[class*="checkout-form__field"]');if(e.id==="state"){document.querySelector(".checkout-form__field.state .form__error_required")?.classList.remove("visible"),e.classList.remove("invalid");return}r.querySelectorAll(".visible").forEach(a=>a.classList.remove("visible")),e.classList.remove("invalid")}function v(e){const r=e.value.trim(),a=g[e.id];return r?a&&!a.test(r)?(m(e,"pattern"),!1):(d(e),!0):(m(e,"required"),!1)}t.querySelectorAll("input").forEach(e=>{e.addEventListener("input",()=>{g[e.id]&&e.id!=="expiry"&&v(e)})}),t.querySelector("#state").addEventListener("change",e=>{e.target.value?d(e.target):m(e.target,"required")}),t.querySelector("#expiry").addEventListener("input",e=>{let r=e.target.value.replace(/\D/g,"");if(r.length>4&&(r=r.slice(0,4)),r.length>=2&&(r=r.slice(0,2)+"/"+r.slice(2)),e.target.value=r,g.expiry){const a=e.target,f=g.expiry;a.value.trim()?f.test(a.value)?d(a):m(a,"pattern"):m(a,"required")}}),t.addEventListener("submit",async e=>{e.preventDefault(),e.stopPropagation();let r=!0;const a=new FormData(t);console.log("FormData Contents:");for(let[p,h]of a.entries())console.log(`${p}: ${h}`);Object.keys(g).forEach(p=>{const h=t.querySelector(`#${p}`);h&&!v(h)&&(r=!1)}),console.log(r);const f=t.querySelector("#state");if(f.value||(m(f,"required"),r=!1),console.log(r),!r){t.querySelector(".invalid")?.scrollIntoView({behavior:"smooth",block:"center"});return}console.log(r);const i=Object.fromEntries(a.entries());console.log("All form data:",i);const y={firstName:i.firstName,lastName:i.lastName,address1:i.address1,address2:i.address2||"",city:i.city,state:i.state,zip:i.zip,email:i.email,phone:i.phone},k={cardNumber:i.cardNumber,expiry:i.expiry,cvc:i.cvc};console.log("Shipping data:",y),console.log("Billing data:",k);try{const p=await D(y);if(p?.error)throw new Error(`Shipping error: ${p.error.message}`);const h=await A(k);if(h?.error)throw new Error(`Billing error: ${h.error.message}`);const q=await L(s,"success");if(q?.error)throw new Error(`Status update error: ${q.error.message}`);const w=await N(c);if(w?.error)throw new Error(`Status update error: ${w.error.message}`);$("Order placed successfully!","success",2e3),setTimeout(()=>{window.location.href=`/checkout-success?order=${s}`},1500)}catch(p){console.error("Error saving data:",p.message),$(`Failed to process order. ${p.message}`,"error");return}})}export{U as initCheckout};
